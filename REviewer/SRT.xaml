<Window x:Class="REviewer.SRT"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="SRT" Height="auto" Width="{Binding WindowWidth, Mode=TwoWay}"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanMinimize"
        SizeToContent="Height"
        Background="{Binding BackgroundBrush}"
        Closing="Window_Closing"
        WindowStyle="None"
        AllowsTransparency="True"
        MouseLeftButtonDown="Window_MouseLeftButtonDown">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Styles/DarkTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <FontFamily x:Key="PixelBoyFont">./resources/fonts/#Pixeboy</FontFamily>

            <Storyboard x:Key="ECGSweepStoryboard" RepeatBehavior="Forever">
                <DoubleAnimation Storyboard.TargetName="MaskStart" Storyboard.TargetProperty="Offset" From="-0.1" To="1.0" Duration="0:0:4"/>
                <DoubleAnimation Storyboard.TargetName="MaskGapStart" Storyboard.TargetProperty="Offset" From="0.0" To="1.1" Duration="0:0:4"/>
                <DoubleAnimation Storyboard.TargetName="MaskGapEnd" Storyboard.TargetProperty="Offset" From="0.01" To="1.11" Duration="0:0:4"/>
                <DoubleAnimation Storyboard.TargetName="MaskEnd" Storyboard.TargetProperty="Offset" From="0.1" To="1.2" Duration="0:0:4"/>
                <DoubleAnimation Storyboard.TargetName="SweepLine" Storyboard.TargetProperty="(Canvas.Left)" From="0" To="400" Duration="0:0:4"/>
            </Storyboard>
        </ResourceDictionary>
    </Window.Resources>

    <Border BorderBrush="{StaticResource Brush.Border.Subtle}" BorderThickness="1">
        <Grid>
            <Grid.LayoutTransform>
                <ScaleTransform ScaleX="{Binding WindowScale}" ScaleY="{Binding WindowScale}"/>
            </Grid.LayoutTransform>

            <Grid.RowDefinitions>
                <RowDefinition Height="32"/>  <!-- Header -->
                <RowDefinition Height="auto"/> <!-- Timer + Character + HP -->
                <RowDefinition Height="auto"/> <!-- Health Bar -->
                <RowDefinition Height="auto"/> <!-- Partner/Sherry -->
                <RowDefinition Height="auto"/> <!-- Key Items -->
                <RowDefinition Height="auto"/> <!-- Inventory -->
                <RowDefinition Height="auto"/> <!-- Item Box -->
                <RowDefinition Height="auto"/> <!-- Stats -->
                <RowDefinition Height="auto"/> <!-- Segments -->
                <RowDefinition Height="auto"/> <!-- Debug -->
                <RowDefinition Height="auto"/> <!-- Buttons -->
            </Grid.RowDefinitions>

            <!-- Header Bar -->
            <Border Grid.Row="0" Style="{StaticResource WindowHeaderBar}" Background="{Binding BackgroundBrush}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="SRT" Style="{StaticResource WindowHeaderTitle}"/>
                    
                    <!-- Settings Button with Popup -->
                    <Button Grid.Column="1" x:Name="SettingsBtn" Style="{StaticResource DockButton}" 
                            ToolTip="Settings" Click="SettingsButton_Click">
                        <Path Data="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
                              Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                              Width="14" Height="14" Stretch="Uniform"/>
                    </Button>
                    <Popup x:Name="SettingsPopup" PlacementTarget="{Binding ElementName=SettingsBtn}" 
                           Placement="Bottom" StaysOpen="False" AllowsTransparency="True">
                        <Border Background="{StaticResource Brush.Background.SideBar}" BorderBrush="{StaticResource Brush.Border.Subtle}" 
                                BorderThickness="1" CornerRadius="4" Padding="12" MinWidth="180">
                            <Grid Margin="0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/> <!-- Header -->
                                    <RowDefinition Height="Auto"/> <!-- Display -->
                                    <RowDefinition Height="Auto"/> <!-- Widgets -->
                                    <RowDefinition Height="Auto"/> <!-- Position -->
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Text="SETTINGS" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,12"/>

                                <!-- DISPLAY SECTION -->
                                <StackPanel Grid.Row="1" Margin="0,0,0,16">
                                    <TextBlock Text="DISPLAY" Foreground="{StaticResource Brush.Text.Secondary}" FontSize="10" FontWeight="Bold" Margin="0,0,0,6"/>
                                    
                                    <CheckBox IsChecked="{Binding StreamerMode}" Margin="0,0,0,6" Foreground="{StaticResource Brush.Text.Primary}">
                                        <TextBlock Text="Streamer Mode (Chroma)" Foreground="{StaticResource Brush.Text.Primary}"/>
                                    </CheckBox>

                                    <Grid Margin="24,0,0,6" IsEnabled="{Binding StreamerMode}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Color:" Foreground="{StaticResource Brush.Text.Secondary}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                        <ComboBox x:Name="ChromaColorCombo" SelectedIndex="0" Width="80" SelectionChanged="ChromaColorCombo_SelectionChanged" HorizontalAlignment="Left">
                                            <ComboBoxItem Content="Green" Tag="#00FF00"/>
                                            <ComboBoxItem Content="Blue" Tag="#0000FF"/>
                                            <ComboBoxItem Content="Magenta" Tag="#FF00FF"/>
                                        </ComboBox>
                                    </Grid>

                                    <CheckBox IsChecked="{Binding TransparentMode}" Margin="0,0,0,6" Foreground="{StaticResource Brush.Text.Primary}">
                                        <TextBlock Text="Transparent Background" Foreground="{StaticResource Brush.Text.Primary}"/>
                                    </CheckBox>
                                </StackPanel>

                                <!-- WIDGETS SECTION -->
                                <StackPanel Grid.Row="2" Margin="0,0,0,16">
                                    <TextBlock Text="WIDGETS" Foreground="{StaticResource Brush.Text.Secondary}" FontSize="10" FontWeight="Bold" Margin="0,0,0,6"/>
                                    
                                    <CheckBox IsChecked="{Binding MinimalItemDisplay}" Margin="0,0,0,6" Foreground="{StaticResource Brush.Text.Primary}">
                                        <TextBlock Text="Compact Item Box" Foreground="{StaticResource Brush.Text.Primary}"/>
                                    </CheckBox>

                                    <CheckBox IsChecked="{Binding ECGHealthDisplay}" Margin="0,0,0,6" Foreground="{StaticResource Brush.Text.Primary}">
                                        <TextBlock Text="ECG Health Monitor" Foreground="{StaticResource Brush.Text.Primary}"/>
                                    </CheckBox>
                                </StackPanel>

                                <!-- OVERLAY SECTION -->
                                <StackPanel Grid.Row="3">
                                    <TextBlock Text="OVERLAY POSITION" Foreground="{StaticResource Brush.Text.Secondary}" FontSize="10" FontWeight="Bold" Margin="0,0,0,6"/>
                                    <ComboBox x:Name="OverlayPositionCombo" SelectedIndex="0" HorizontalAlignment="Stretch" SelectionChanged="OverlayPositionCombo_SelectionChanged">
                                        <ComboBoxItem Content="Bottom Right" Tag="0"/>
                                        <ComboBoxItem Content="Top Right" Tag="1"/>
                                        <ComboBoxItem Content="Top Left" Tag="2"/>
                                        <ComboBoxItem Content="Bottom Left" Tag="3"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Popup>
                    
                    <!-- Dock Button -->
                    <Button Grid.Column="2" x:Name="DockBtn" Style="{StaticResource DockButton}" 
                            Click="DockButton_Click" ToolTip="Dock with Enemy Tracker">
                        <Path Data="M3,3 L13,3 L13,13 L3,13 Z M5,0 L15,0 L15,10 L13,10 L13,3 L5,3 Z" 
                              Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>
                    <!-- Close Button -->
                    <Button Grid.Column="3" Style="{StaticResource DockButton}" Click="CloseButton_Click">
                        <Path Data="M0,0 L8,8 M8,0 L0,8" 
                              Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                              StrokeThickness="1.5" Width="10" Height="10"/>
                    </Button>
                </Grid>
            </Border>

            <!-- Timer + Character + HP Section -->
            <Border Grid.Row="1" Background="{Binding BackgroundBrush}" Padding="16,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Timer -->
                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                        <TextBlock Text="IGT" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,2"/>
                        <TextBlock Name="IGTimer" Text="{Binding IGTHumanFormat}" 
                                   Foreground="{Binding TimerColorBrush}"
                                   Style="{StaticResource TimerDisplay}"/>
                    </StackPanel>

                    <!-- Character Badge -->
                    <Border Grid.Column="1" Style="{StaticResource CharacterBadge}" 
                            VerticalAlignment="Center" Margin="16,0">
                        <StackPanel>
                            <TextBlock Text="CHAR" FontSize="9" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Name="Character" Text="{Binding CharacterName}" 
                                       Foreground="{StaticResource Brush.Text.White}" 
                                       FontSize="16" FontWeight="SemiBold" 
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- HP Display -->
                    <Border Grid.Column="2" Style="{StaticResource CharacterBadge}" 
                            VerticalAlignment="Center">
                        <StackPanel>
                            <!-- Heart Icon Removed -->
                            <TextBlock Text="HP" FontSize="10" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Name="Health" Text="{Binding Health.Value}" 
                                       Foreground="{Binding Health.Background}" 
                                       Style="{StaticResource HPValue}" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <!-- Selected Item Qty -->
                    <Border Grid.Column="3" Style="{StaticResource CharacterBadge}" 
                            VerticalAlignment="Center" Margin="16,0,0,0">
                        <StackPanel>
                            <TextBlock Text="#" FontSize="10" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding InventorySlotSelectedQuantity}" 
                                       Foreground="{StaticResource Brush.Text.White}" 
                                       Style="{StaticResource HPValue}" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>

            <!-- Health Bar Section -->
            <Border Grid.Row="2" Background="{Binding BackgroundBrush}" 
                    Padding="16,0,16,12" Visibility="{Binding HealthBarVisibility}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                <!-- Player Health Bar (Standard) -->
                    <Grid Grid.Row="0" Visibility="{Binding StandardHealthVisibility}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>
                        <ProgressBar Grid.Column="0" Name="HealthBar" 
                                     Value="{Binding Health.Value}" Maximum="{Binding MaxHealth}" 
                                     Foreground="{Binding Health.Background}" 
                                     Style="{StaticResource HealthBarModern}" Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="1" Style="{StaticResource MonoStatus}" 
                                   VerticalAlignment="Center" HorizontalAlignment="Right">
                            <Run Text="{Binding Health.Value, Mode=OneWay}"/><Run Text="/"/><Run Text="{Binding MaxHealth, Mode=OneWay}"/>
                        </TextBlock>
                    </Grid>

                    <!-- Player Health Monitor (ECG Style) -->
                    <Grid Grid.Row="0" Visibility="{Binding ECGHealthVisibility}" Height="80" Margin="0,0,0,8">
                         <Border Background="#000000" BorderBrush="#333333" BorderThickness="2" CornerRadius="4" ClipToBounds="True">
                                <Grid>
                                    <Grid.Resources>
                                        <!-- Grid Lines -->
                                        <DrawingBrush x:Key="GridBrush" TileMode="Tile" Viewport="0,0,20,20" ViewportUnits="Absolute">
                                            <DrawingBrush.Drawing>
                                                <GeometryDrawing>
                                                    <GeometryDrawing.Pen>
                                                        <Pen Brush="#1A1A1A" Thickness="1"/>
                                                    </GeometryDrawing.Pen>
                                                    <GeometryDrawing.Geometry>
                                                        <GeometryGroup>
                                                            <LineGeometry StartPoint="0,0" EndPoint="0,20"/>
                                                            <LineGeometry StartPoint="0,0" EndPoint="20,0"/>
                                                        </GeometryGroup>
                                                    </GeometryDrawing.Geometry>
                                                </GeometryDrawing>
                                            </DrawingBrush.Drawing>
                                        </DrawingBrush>
                                    </Grid.Resources>
                                    <Rectangle Fill="{StaticResource GridBrush}"/>

                                    <!-- Pulse Line (Dynamic Points with Sweep Effect) -->
                                    <Canvas>
                                        <Polyline Points="{Binding ECGPoints}"
                                                  Stroke="{Binding Health.Background}" StrokeThickness="3"
                                                  StrokeLineJoin="Round" StrokeStartLineCap="Round" StrokeEndLineCap="Round"
                                                  VerticalAlignment="Center">
                                            <Polyline.Effect>
                                                <DropShadowEffect Color="{Binding Health.Background.Color}" BlurRadius="15" ShadowDepth="0" Opacity="0.9"/>
                                            </Polyline.Effect>
                                            <Polyline.OpacityMask>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                    <GradientStop x:Name="MaskStart" Color="Black" Offset="0"/>
                                                    <GradientStop x:Name="MaskGapStart" Color="Black" Offset="0.1"/>
                                                    <GradientStop x:Name="MaskGapEnd" Color="Transparent" Offset="0.11"/>
                                                    <GradientStop x:Name="MaskEnd" Color="Transparent" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Polyline.OpacityMask>
                                        </Polyline>

                                        <!-- Vertical Sweep Line (Bright Tip) -->
                                        <Rectangle x:Name="SweepLine" Width="2" Height="80" Fill="White" Opacity="0.8">
                                            <Rectangle.Effect>
                                                <BlurEffect Radius="4"/>
                                            </Rectangle.Effect>
                                        </Rectangle>
                                    </Canvas>
                                    
                                    <!-- Scanline / Vignette -->
                                    <Rectangle IsHitTestVisible="False">
                                        <Rectangle.Fill>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="#00000000" Offset="0"/>
                                                <GradientStop Color="#00000000" Offset="0.1"/>
                                                <GradientStop Color="#00000000" Offset="0.9"/>
                                                <GradientStop Color="#00000000" Offset="1"/>
                                            </LinearGradientBrush>
                                        </Rectangle.Fill>
                                    </Rectangle>
                                    <Rectangle IsHitTestVisible="False" Opacity="0.1">
                                        <Rectangle.Fill>
                                            <RadialGradientBrush>
                                                <GradientStop Color="Transparent" Offset="0.8"/>
                                                <GradientStop Color="Black" Offset="1"/>
                                            </RadialGradientBrush>
                                        </Rectangle.Fill>
                                    </Rectangle>

                                    <!-- Digital Readout -->
                                    <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,8,12,0">
                                        <TextBlock Text="ECG // MONITOR" FontSize="9" Foreground="#666666" HorizontalAlignment="Right" FontFamily="Consolas"/>
                                        <TextBlock Text="{Binding Health.Value}" Foreground="{Binding Health.Background}" 
                                                   FontFamily="Consolas" FontWeight="Bold" FontSize="20" HorizontalAlignment="Right">
                                            <TextBlock.Effect>
                                                <DropShadowEffect Color="{Binding Health.Background.Color}" BlurRadius="5" ShadowDepth="0"/>
                                            </TextBlock.Effect>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                        </Border>
                    </Grid>

                    <!-- Partner Health Bar -->
                    <Grid Grid.Row="1" Visibility="{Binding PartnerVisibility}" Margin="0,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Partner" 
                                   Style="{StaticResource MonoStatus}" 
                                   VerticalAlignment="Center" Margin="0,0,8,0"
                                   Foreground="{StaticResource Brush.Text.Secondary}"/>
                        <ProgressBar Grid.Column="1" Name="PartnerHealthBar" 
                                     Value="{Binding PartnerHPValue, Mode=OneWay}" Maximum="{Binding PartnerMaxHPValue, Mode=OneWay}"
                                     Style="{StaticResource HealthBarModern}" 
                                     Foreground="{StaticResource Brush.Status.Success}" Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="2" Style="{StaticResource MonoStatus}" 
                                   VerticalAlignment="Center" HorizontalAlignment="Right">
                            <Run Text="{Binding PartnerHPValue, Mode=OneWay}"/><Run Text="/"/><Run Text="{Binding PartnerMaxHPValue, Mode=OneWay}"/>
                        </TextBlock>
                    </Grid>
                </Grid>
            </Border>

            <!-- Sherry Section -->
            <Border Grid.Row="3" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding SherryVisibility}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Image Grid.Column="0" Source="{Binding SherryPicture}" Height="48" Width="48" Margin="0,0,12,0"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="SHERRY" Style="{StaticResource SRTSectionHeader}" Margin="0"/>
                        <TextBlock Name="SherryStatus" Text="{Binding SherryPose}" 
                                   Foreground="{StaticResource Brush.Text.White}" FontSize="14"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Key Items Section -->
            <Border Grid.Row="4" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding KeyItemsVisibility}">
                <StackPanel>
                    <TextBlock Text="KEY ITEMS" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                    <ItemsControl ItemsSource="{Binding KeyItemImages}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource ItemSlot}"
                                        Background="{Binding DataContext.ItemSlotBrush, RelativeSource={RelativeSource AncestorType=Window}}"
                                        BorderBrush="{Binding DataContext.ItemSlotBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}">
                                    <Image Source="{Binding Source}" 
                                           Width="48" Height="42" 
                                           Opacity="{Binding Opacity}"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Inventory Section -->
            <Border Grid.Row="5" Background="{Binding BackgroundBrush}" Padding="16,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Main Inventory -->
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="INVENTORY" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                        <ItemsControl ItemsSource="{Binding InventoryImages}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource ItemSlot}"
                                            Background="{Binding DataContext.ItemSlotBrush, RelativeSource={RelativeSource AncestorType=Window}}"
                                            BorderBrush="{Binding DataContext.ItemSlotBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}">
                                        <Grid>
                                            <Image Source="{Binding Source}" 
                                                   Width="72" Height="54" 
                                                   Opacity="{Binding Opacity}"/>
                                            <TextBlock Text="{Binding Text}" 
                                                       Visibility="{Binding TextVisibility}"
                                                       Foreground="{Binding Color}"
                                                       FontFamily="Cascadia Code, Consolas"
                                                       FontSize="14" FontWeight="Bold"
                                                       HorizontalAlignment="Right" 
                                                       VerticalAlignment="Bottom"
                                                       Margin="0,0,4,2">
                                                    <TextBlock.Effect>
                                                        <DropShadowEffect ShadowDepth="1" Direction="315" Color="Black" Opacity="1" BlurRadius="3"/>
                                                    </TextBlock.Effect>
                                                </TextBlock>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Selected + Last Seen -->
                    <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Top">
                        <!-- Selected Item -->
                        <TextBlock Text="SELECT" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,4"/>
                        <Border Style="{StaticResource ItemSlotSelected}">
                            <Image Name="SelectItem" Source="{Binding InventorySlotSelectedImage}" 
                                   Height="54" Width="64"/>
                        </Border>

                        <!-- Last Item Seen -->
                        <StackPanel Visibility="{Binding LastItemSeenVisibility}">
                            <TextBlock Text="LAST" Style="{StaticResource SRTSectionHeader}" Margin="0,8,0,4"/>
                            <Border Style="{StaticResource ItemSlot}">
                                <Image Name="LastItemSeen" Source="{Binding LastItemFoundImage}" 
                                       Height="54" Width="64"/>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Item Box Section -->
            <Border Grid.Row="6" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding ItemBoxVisibility}">
                <StackPanel>
                    <TextBlock Text="ITEM BOX" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                    <ItemsControl ItemsSource="{Binding ItemboxImages}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource ItemSlot}" Visibility="{Binding Visibility}">
                                    <Image Source="{Binding Source}" 
                                           Width="{Binding Width}" Height="{Binding Height}" 
                                           Opacity="{Binding Opacity}"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Stats Section -->
            <Border Grid.Row="7" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding StatsVisibility}">
                <StackPanel>
                    <TextBlock Text="STATISTICS" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                    <UniformGrid Columns="4">
                        <Border Style="{StaticResource StatBadge}">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="DEATHS" FontSize="9" 
                                           Foreground="{StaticResource Brush.Text.Secondary}" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Name="Death" Text="{Binding Deaths}" 
                                           Style="{StaticResource StatValue}" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        <Border Style="{StaticResource StatBadge}">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="SAVES" FontSize="9" 
                                           Foreground="{StaticResource Brush.Text.Secondary}" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Name="Saves" Text="{Binding Saves}" 
                                           Style="{StaticResource StatValue}" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        <Border Style="{StaticResource StatBadge}">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="RESETS" FontSize="9" 
                                           Foreground="{StaticResource Brush.Text.Secondary}" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Name="Resets" Text="{Binding Resets}" 
                                           Style="{StaticResource StatValue}" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        <Border Style="{StaticResource StatBadge}">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="HITS" FontSize="9" 
                                           Foreground="{StaticResource Brush.Text.Secondary}" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Name="Hit" Text="{Binding Hits}" 
                                           Style="{StaticResource StatValue}" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                    </UniformGrid>
                </StackPanel>
            </Border>

            <!-- Segment Timers -->
            <Border Grid.Row="8" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding SegsVisibility}">
                <StackPanel>
                    <TextBlock Text="SEGMENTS" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                    <UniformGrid Columns="4">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="SEG 1" FontSize="9" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding IGTSHumanFormat[0]}" 
                                       Style="{StaticResource SegmentTimer}"/>
                        </StackPanel>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="SEG 2" FontSize="9" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding IGTSHumanFormat[1]}" 
                                       Style="{StaticResource SegmentTimer}"/>
                        </StackPanel>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="SEG 3" FontSize="9" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding IGTSHumanFormat[2]}" 
                                       Style="{StaticResource SegmentTimer}"/>
                        </StackPanel>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="SEG 4" FontSize="9" 
                                       Foreground="{StaticResource Brush.Text.Secondary}" 
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding IGTSHumanFormat[3]}" 
                                       Style="{StaticResource SegmentTimer}"/>
                        </StackPanel>
                    </UniformGrid>
                </StackPanel>
            </Border>

            <!-- Debug Section -->
            <Border Grid.Row="9" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" Visibility="{Binding DebugModeVisibility}">
                <StackPanel>
                    <TextBlock Text="DEBUG" Style="{StaticResource SRTSectionHeader}" Margin="0,0,0,6"/>
                    <StackPanel Orientation="Horizontal">
                        <Button Name="CoordsHex" Content="Coords Hex" 
                                Style="{StaticResource SRTFlatButton}" 
                                Click="Coords_Hex_Click" Margin="0,0,8,0"/>
                        <Button Name="Coords" Content="Coords Dec" 
                                Style="{StaticResource SRTFlatButton}" 
                                Click="Coords_Dec_Click"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Action Buttons -->
            <Border Grid.Row="10" Background="{Binding BackgroundBrush}" 
                    Padding="16,8" BorderBrush="{StaticResource Brush.Border.Subtle}" 
                    BorderThickness="0,1,0,0">
                <StackPanel Orientation="Horizontal">
                    <Button Name="Reset" Content="Reset" 
                            Style="{StaticResource SRTFlatButton}" 
                            Click="Reset_Click"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</Window>
